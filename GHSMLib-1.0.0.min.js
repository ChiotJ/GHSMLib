/**
 * version:1.0.0
 * Created by jianyingshuo on 2015/12/08.
 */
"use strict";!function(t,n){function e(t){var n=this;this.initStatus=!1,this.ui={cardId:t},this.fun=[];var e,i=function(){r.ajax({url:"http://172.16.188.26/chaowai/box/getBoxByCardId",data:{cardId:n.ui.cardId},type:"GET",dataType:"json",success:function(t){t.success?(n.ui.name=t.result.name,n.ui.phone=t.result.phone,n.ui.address=t.result.address,n.ui.location={},n.ui.location.lat=t.result.latitude,n.ui.location.lng=t.result.longitude,"object"==typeof t.result.department&&(n.ui.departmentId=t.result.department.id),a()):(n.err="\u670d\u52a1\u5668\u9519\u8bef",o())},error:function(t){n.err="\u670d\u52a1\u5668\u9519\u8bef",o()}})},u=function(){var t={lat:n.ui.location.lat,lng:n.ui.location.lng},i=e.communitys;for(var u in i){var r=i[u],s=r.poly,a=f(t,s);if(a){var d=n.ui.departmentId;n.ui.departmentId=r.id1,n.ui.street=e.id,n.ui.community={},n.ui.community.name=r.name,n.ui.community.id1=r.id1,n.ui.community.id2=r.id2,(void 0===d||d!=n.ui.departmentId)&&c();break}}void 0===n.ui.community&&(n.ui.community="\u6b64\u5730\u5740\u4e0d\u5c5e\u4e8e\u4efb\u4f55\u793e\u533a"),o()},o=function(){if(n.initStatus=!0,n.fun.length>0)for(var t in n.fun)n.fun[t](n.ui,n.err)},c=function(){r.ajax({url:"http://172.16.188.26/chaowai/box/save",type:"POST",async:!1,data:{cardId:n.ui.cardId,address:n.ui.address,name:n.ui.name,phone:n.ui.phone,latitude:n.ui.location.lat,longitude:n.ui.location.lng,departmentId:n.ui.community.id1},success:function(t){}})},a=function(){r.getJSON(s+"/json/map/polygon/11e6801f-9a5d-4a6b-be6c-e6bc7820cc57.json",function(t){e=t,u()})},f=function(t,n){for(var e=!1,i=-1,u=n.length,o=u-1;++i<u;o=i)(n[i].lat<=t.lat&&t.lat<n[o].lat||n[o].lat<=t.lat&&t.lat<n[i].lat)&&t.lng<(n[o].lng-n[i].lng)*(t.lat-n[i].lat)/(n[o].lat-n[i].lat)+n[i].lng&&(e=!e);return e};i()}function i(t,n){return"object"==typeof t?(this.mList=t,"number"!=typeof n||0>n||n>2?this.type=1:this.type=n,this.len=this.mList.length,this.currentIndex=-1,this.audio=null,this.init(),this):void 0}function u(){this.index={},this.size={}}function o(){this.wsUrl="",this.subscribe="",this.actions={},this.client=null}function c(){this.cardId="undefined"!=typeof CyberCloud?CyberCloud.GetParam("CardID").ParamValue?CyberCloud.GetParam("CardID").ParamValue:CyberCloud.GetParam("UserCode").ParamValue?CyberCloud.GetParam("UserCode").ParamValue.replace("CA",""):"":"",this._WS=new o,this._initScript(),this.utils=a,this.keyCon=new u,this.AudioPlayer=i;var t=new e(this.cardId);this.getUserInfo=function(n){t.getUserInfo(n)}}var r=null,s="http://172.16.188.26/web/GHSMLib",a=function(){var e={};return e.getTime=Date.now||(new Date).getTime(),e.extend=function(t,n){for(var e in n)n.hasOwnProperty(e)&&(t[e]=n[e])},e.loadScript=function(t,e){var i=n.getElementsByTagName("head")[0];if(i){var u=n.createElement("script");u.setAttribute("src",t),u.setAttribute("type","text/javascript"),u.onload=e,i.appendChild(u)}},e.qrCode=function(t,n){return"http://172.16.188.13/api/common/Image/qrCode.png?text="+t+"&size="+n},e.getQueryString=function(n){var e=RegExp("(^|&)"+n+"=([^&]*)(&|$)","i"),i=t.location.search.substr(1).match(e);return null!=i?i[2]:null},e.getHashString=function(n){var e=RegExp("(^|&|#)"+n+"=([^&]*)(&|$)","i"),i=t.location.hash.substr(1).match(e);return null!=i?i[2]:null},e}();e.prototype={getUserInfo:function(t){"function"==typeof t?this.initStatus?t(this.ui,this.err):this.fun.push(t):console.error("\u53c2\u6570\u9519\u8bef")}},i.prototype={init:function(){var t=this,e=n.createElement("audio"),i=n.getElementsByTagName("body")[0];e.style.display="none",i.appendChild(e),this.audio=e,t.play(),e.onended=function(){t.next()}},next:function(){var t=this.type,n=this.currentIndex;if(0==t)-1==n&&(n=0);else if(1==t)-1==n?n=0:n==this.len-1?n=0:n++;else if(2==t&&(n=parseInt(this.len*Math.random()),this.len>1&&n==this.currentIndex||n>this.len-1||0>n))return void this.next();this.playByIdx(n)},pre:function(){},pause:function(){this.audio.pause()},play:function(){-1==this.currentIndex?this.next():this.audio.play()},playByIdx:function(t){this.audio.src=this.mList[t],this.audio.play(),this.currentIndex=t},addMusic:function(t){this.mList.push(t),this.len=this.mList.length},setMusic:function(t){this.mList=t,this.len=this.mList.length},setType:function(t){"number"==typeof t&&t>=0&&3>t&&(this.type=t,console.log(this.type))}},u.prototype={_executeFun:function(t,n){var e=["before","center","after"],i=!0;if("function"==typeof t)i=t(n),void 0===i&&(i=!0);else if("object"==typeof t)for(var u in e)"function"==typeof t[e[u]]&&i&&(i=t[e[u]](n),void 0===i&&(i=!0));return i},keyListener:function(t){var e=this,i=t.id,u=r("#"+i),o=u;n.getElementById(i).onkeydown=function(n){var i=n.target;switch(n&&n.keyCode){case 8:return e._executeFun(t.back,i);case 13:return e._executeFun(t.enter,i);case 27:return e._executeFun(t.esc,i);case 33:return e._executeFun(t.pageUp,i);case 34:return e._executeFun(t.pageDown,i);case 37:return e._executeFun(t.left,i);case 38:return e._executeFun(t.up,i);case 39:return e._executeFun(t.right,i);case 40:return e._executeFun(t.down,i);case 48:return e._executeFun(t.n0,i);case 49:return e._executeFun(t.n1,i);case 50:return e._executeFun(t.n2,i);case 51:return e._executeFun(t.n3,i);case 52:return e._executeFun(t.n4,i);case 53:return e._executeFun(t.n5,i);case 54:return e._executeFun(t.n6,i);case 55:return e._executeFun(t.n7,i);case 56:return e._executeFun(t.n8,i);case 57:return e._executeFun(t.n9,i)}},t.label&&(o=u.find(t.label)),o.focus(function(){"function"==typeof t.focus&&t.focus(this)}),o.blur(function(){"function"==typeof t.blur&&t.blur(this)}),o.click(function(){var n=!0;"function"==typeof t.click&&(n=t.click(this),void 0===n&&(n=!0)),"function"==typeof t.enter&&n&&(r(this).attr("tabindex","-1").focus(),t.enter(this))})},listKeyListener:function(t){var n=this,e=t.id,i=r("#"+e).find(t.label),u=i.length;if(n.index[e]=0,n.size[e]=u,"function"!=typeof t.left&&("object"!=typeof t.left?t.left=function(t){var n=r(t).index();r(i[--n]).attr("tabindex",-1).focus()}:"function"!=typeof t.left.center&&(t.left.center=function(t){var n=r(t).index();r(i[--n]).attr("tabindex",-1).focus()})),"function"!=typeof t.up&&("object"!=typeof t.up?t.up=function(n){var e=r(n).index();e>t.columnNum-1&&(e-=t.columnNum,r(i[e]).attr("tabindex",-1).focus())}:"function"!=typeof t.up.center&&(t.up.center=function(n){var e=r(n).index();e>t.columnNum-1&&(e-=t.columnNum,r(i[e]).attr("tabindex",-1).focus())})),"function"!=typeof t.right&&("object"!=typeof t.right?t.right=function(t){var n=r(t).index();u-1>n&&r(i[++n]).attr("tabindex",-1).focus()}:"function"!=typeof t.right.center&&(t.right.center=function(t){var n=r(t).index();u-1>n&&r(i[++n]).attr("tabindex",-1).focus()})),"function"!=typeof t.down&&("object"!=typeof t.down?t.down=function(n){var e=r(n).index();e<u-t.columnNum&&(e+=t.columnNum,r(i[e]).attr("tabindex",-1).focus())}:"function"!=typeof t.down.center&&(t.down.center=function(n){var e=r(n).index();e<u-t.columnNum&&(e+=t.columnNum,r(i[e]).attr("tabindex",-1).focus())})),"function"==typeof t.focus){var o=t.focus;t.focus=function(t){n.index[e]=r(t).index(),o(t)}}else t.focus=function(t){n.index[e]=r(t).index()};n.keyListener(t)}},o.prototype={_init:function(t){this.cardId=t,this._verifyWS()},connect:function(){var n=this,e=new SockJS(this.wsUrl+this.cardId);this.client=Stomp.over(e),this.client.debug=function(t){},this.client.connect({},function(){n._subscribe()},this.onClose(n)),t.onbeforeunload=function(){n.disconnect()}},disconnect:function(){this.client.disconnect(),this.client=null},_verifyWS:function(){var t=this,n=r("#GHSMLib").attr("key");n&&r.getJSON(s+"/json/application/"+n+".json",function(n){t.wsUrl=n.ws,t.subscribe=n.subscribe,""!=this.wsUrl?t.connect():console.error("\u9519\u8bef\u7684ws")})},_subscribe:function(){var t=this;this.client.subscribe(t.subscribe,function(n){var e=JSON.parse(n.body),i=e.action,u=e.props;t.actions[i]&&"function"==typeof t.actions[i]&&t.actions[i](u,e.openId)})},onClose:function(t){return function(){setTimeout(function(){t.connect()},1e3)}},addActions:function(t){return"object"==typeof t?(a.extend(this.actions,t),!0):!1}},c.prototype={version:"1.0.0.201601292216",_init:function(){this._WS._init(this.cardId)},_initScript:function(){var n=0,e=2,i=5e3,u=s+"/lib/",o=this,c=function(){n++,n==e&&o._init()};!t.jQuery||t.jQuery&&t.jQuery().jquery.substring(0,3)<1.9?(e++,a.loadScript(u+"jquery-2.1.3.min.js",function(){r=jQuery.noConflict(!0),c()})):r=t.jQuery,a.loadScript(u+"sockjs-1.0.0.min.js",c),a.loadScript(u+"stomp.min.js",c),setTimeout(function(){n!=e&&console.error("js\u6587\u4ef6\u52a0\u8f7d\u8d85\u65f6")},i)},addActions:function(t){var n=!1;return"object"==typeof t&&this._WS&&(n=this._WS.addActions(t)),n}},t.GHSMLib=new c}(window,document);