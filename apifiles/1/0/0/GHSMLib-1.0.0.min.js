/**
 * version:1.0.0
 * Created by jianyingshuo on 2015/12/08.
 */
!function(t,e){"use strict";function n(e){var n,i=t.location.hostname,u=t.location.pathname;s.ajax({url:a+"/json/userBehavior/pvSetting.json",async:!1,success:function(t){var e=t[i];if(e&&e.length>0)for(var o in e){var r=e[o].regular,c=e[o].name;for(var s in r)0==u.indexOf(r[s])&&(n=c)}}}),n&&e&&(this.appName=n,this.cardId=e,this.pv())}function i(t){var e=this;this.initStatus=!1,this.ui={cardId:t},this.fun=[];var n,i=function(){s.ajax({url:"http://172.16.188.26/chaowai/box/getBoxByCardId",data:{cardId:e.ui.cardId},type:"GET",dataType:"json",success:function(t){t.success?(e.ui.name=t.result.name,e.ui.phone=t.result.phone,e.ui.address=t.result.address,e.ui.location={},e.ui.location.lat=t.result.latitude,e.ui.location.lng=t.result.longitude,"object"==typeof t.result.department&&(e.ui.departmentId=t.result.department.id),c()):(e.err="\u670d\u52a1\u5668\u9519\u8bef",o())},error:function(t){e.err="\u670d\u52a1\u5668\u9519\u8bef",o()}})},u=function(){var t={lat:e.ui.location.lat,lng:e.ui.location.lng},i=n.communitys;for(var u in i){var c=i[u],s=c.poly,a=d(t,s);if(a){var f=e.ui.departmentId;e.ui.departmentId=c.id1,e.ui.street=n.id,e.ui.community={},e.ui.community.name=c.name,e.ui.community.id1=c.id1,e.ui.community.id2=c.id2,(void 0===f||f!=e.ui.departmentId)&&r();break}}void 0===e.ui.community&&(e.ui.community="\u6b64\u5730\u5740\u4e0d\u5c5e\u4e8e\u4efb\u4f55\u793e\u533a"),o()},o=function(){if(e.initStatus=!0,e.fun.length>0)for(var t in e.fun)e.fun[t](e.ui,e.err)},r=function(){s.ajax({url:"http://172.16.188.26/chaowai/box/save",type:"POST",async:!1,data:{cardId:e.ui.cardId,address:e.ui.address,name:e.ui.name,phone:e.ui.phone,latitude:e.ui.location.lat,longitude:e.ui.location.lng,departmentId:e.ui.community.id1},success:function(t){}})},c=function(){s.getJSON(a+"/json/map/polygon/11e6801f-9a5d-4a6b-be6c-e6bc7820cc57.json",function(t){n=t,u()})},d=function(t,e){for(var n=!1,i=-1,u=e.length,o=u-1;++i<u;o=i)(e[i].lat<=t.lat&&t.lat<e[o].lat||e[o].lat<=t.lat&&t.lat<e[i].lat)&&t.lng<(e[o].lng-e[i].lng)*(t.lat-e[i].lat)/(e[o].lat-e[i].lat)+e[i].lng&&(n=!n);return n};i()}function u(t,e){return"object"==typeof t?(this.mList=t,"number"!=typeof e||0>e||e>2?this.type=1:this.type=e,this.len=this.mList.length,this.currentIndex=-1,this.audio=null,this.init(),this):void 0}function o(){this.index={},this.size={}}function r(){this.wsUrl="",this.subscribe="",this.actions={},this.client=null}function c(){this.cardId="undefined"!=typeof CyberCloud?CyberCloud.GetParam("CardID").ParamValue?CyberCloud.GetParam("CardID").ParamValue:CyberCloud.GetParam("UserCode").ParamValue?CyberCloud.GetParam("UserCode").ParamValue.replace("CA",""):"":"",this._WS=new r,this._initScript(),this.utils=d,this.keyCon=new o,this.AudioPlayer=u;var t=new i(this.cardId);this.getUserInfo=function(e){t.getUserInfo(e)};new n(this.cardId)}var s=null,a="http://172.16.188.26/web/GHSMLib",d=function(){var n={};return n.getTime=Date.now||(new Date).getTime(),n.extend=function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])},n.loadScript=function(t,n){var i=e.getElementsByTagName("head")[0];if(i){var u=e.createElement("script");u.setAttribute("src",t),u.setAttribute("type","text/javascript"),u.onload=n,i.appendChild(u)}},n.qrCode=function(t,e){return"http://172.16.188.13/api/common/Image/qrCode.png?text="+t+"&size="+e},n.getQueryString=function(e){var n=RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),i=t.location.search.substr(1).match(n);return null!=i?i[2]:null},n.getHashString=function(e){var n=RegExp("(^|&|#)"+e+"=([^&]*)(&|$)","i"),i=t.location.hash.substr(1).match(n);return null!=i?i[2]:null},n}();n.prototype.pv=function(){var t=(new Date).getTime();s.getJSON("http://172.16.188.26/web/userBehavior/pv.json?appName="+this.appName+"&cardId="+this.cardId+"&timestamp="+t)},i.prototype={getUserInfo:function(t){"function"==typeof t?this.initStatus?t(this.ui,this.err):this.fun.push(t):console.error("\u53c2\u6570\u9519\u8bef")}},u.prototype={init:function(){var t=this,n=e.createElement("audio"),i=e.getElementsByTagName("body")[0];n.style.display="none",i.appendChild(n),this.audio=n,t.play(),n.onended=function(){t.next()}},next:function(){var t=this.type,e=this.currentIndex;if(0==t)-1==e&&(e=0);else if(1==t)-1==e?e=0:e==this.len-1?e=0:e++;else if(2==t&&(e=parseInt(this.len*Math.random()),this.len>1&&e==this.currentIndex||e>this.len-1||0>e))return void this.next();this.playByIdx(e)},pre:function(){},pause:function(){this.audio.pause()},play:function(){-1==this.currentIndex?this.next():this.audio.play()},playByIdx:function(t){this.audio.src=this.mList[t],this.audio.play(),this.currentIndex=t},addMusic:function(t){this.mList.push(t),this.len=this.mList.length},setMusic:function(t){this.mList=t,this.len=this.mList.length},setType:function(t){"number"==typeof t&&t>=0&&3>t&&(this.type=t)}},o.prototype={_executeFun:function(t,e){var n=["before","center","after"],i=!0;if("function"==typeof t)i=t(e),void 0===i&&(i=!0);else if("object"==typeof t)for(var u in n)"function"==typeof t[n[u]]&&i&&(i=t[n[u]](e),void 0===i&&(i=!0));return i},keyListener:function(t){var n=this,i=t.id,u=s("#"+i),o=u;e.getElementById(i).onkeydown=function(e){var i=e.target;switch(e&&e.keyCode){case 8:return n._executeFun(t.back,i);case 13:return n._executeFun(t.enter,i);case 27:return n._executeFun(t.esc,i);case 33:return n._executeFun(t.pageUp,i);case 34:return n._executeFun(t.pageDown,i);case 37:return n._executeFun(t.left,i);case 38:return n._executeFun(t.up,i);case 39:return n._executeFun(t.right,i);case 40:return n._executeFun(t.down,i);case 48:return n._executeFun(t.n0,i);case 49:return n._executeFun(t.n1,i);case 50:return n._executeFun(t.n2,i);case 51:return n._executeFun(t.n3,i);case 52:return n._executeFun(t.n4,i);case 53:return n._executeFun(t.n5,i);case 54:return n._executeFun(t.n6,i);case 55:return n._executeFun(t.n7,i);case 56:return n._executeFun(t.n8,i);case 57:return n._executeFun(t.n9,i)}},t.label&&(o=u.find(t.label)),o.focus(function(){"function"==typeof t.focus&&t.focus(this)}),o.blur(function(){"function"==typeof t.blur&&t.blur(this)}),o.click(function(){var e=!0;"function"==typeof t.click&&(e=t.click(this),void 0===e&&(e=!0)),"function"==typeof t.enter&&e&&(s(this).attr("tabindex","-1").focus(),t.enter(this))})},listKeyListener:function(t){var e=this,n=t.id,i=s("#"+n).find(t.label),u=i.length;if(e.index[n]=0,e.size[n]=u,"function"!=typeof t.left&&("object"!=typeof t.left?t.left=function(t){var e=s(t).index();s(i[--e]).attr("tabindex",-1).focus()}:"function"!=typeof t.left.center&&(t.left.center=function(t){var e=s(t).index();s(i[--e]).attr("tabindex",-1).focus()})),"function"!=typeof t.up&&("object"!=typeof t.up?t.up=function(e){var n=s(e).index();n>t.columnNum-1&&(n-=t.columnNum,s(i[n]).attr("tabindex",-1).focus())}:"function"!=typeof t.up.center&&(t.up.center=function(e){var n=s(e).index();n>t.columnNum-1&&(n-=t.columnNum,s(i[n]).attr("tabindex",-1).focus())})),"function"!=typeof t.right&&("object"!=typeof t.right?t.right=function(t){var e=s(t).index();u-1>e&&s(i[++e]).attr("tabindex",-1).focus()}:"function"!=typeof t.right.center&&(t.right.center=function(t){var e=s(t).index();u-1>e&&s(i[++e]).attr("tabindex",-1).focus()})),"function"!=typeof t.down&&("object"!=typeof t.down?t.down=function(e){var n=s(e).index();n<u-t.columnNum&&(n+=t.columnNum,s(i[n]).attr("tabindex",-1).focus())}:"function"!=typeof t.down.center&&(t.down.center=function(e){var n=s(e).index();n<u-t.columnNum&&(n+=t.columnNum,s(i[n]).attr("tabindex",-1).focus())})),"function"==typeof t.focus){var o=t.focus;t.focus=function(t){e.index[n]=s(t).index(),o(t)}}else t.focus=function(t){e.index[n]=s(t).index()};e.keyListener(t)}},r.prototype={_init:function(t){this.cardId=t,this._verifyWS()},connect:function(){var e=this,n=new SockJS(this.wsUrl+this.cardId);this.client=Stomp.over(n),this.client.debug=function(t){},this.client.connect({},function(){e._subscribe()},this.onClose(e)),t.onbeforeunload=function(){e.disconnect()}},disconnect:function(){this.client.disconnect(),this.client=null},_verifyWS:function(){var t=this,e=s("#GHSMLib").attr("key");e&&s.getJSON(a+"/json/application/"+e+".json",function(e){t.wsUrl=e.ws,t.subscribe=e.subscribe,""!=this.wsUrl?t.connect():console.error("\u9519\u8bef\u7684ws")})},_subscribe:function(){var t=this;this.client.subscribe(t.subscribe,function(e){var n=JSON.parse(e.body),i=n.action,u=n.props;t.actions[i]&&"function"==typeof t.actions[i]&&t.actions[i](u,n.openId)})},onClose:function(t){return function(){setTimeout(function(){t.connect()},1e3)}},addActions:function(t){return"object"==typeof t?(d.extend(this.actions,t),!0):!1}},c.prototype={version:"1.0.0.201602041104",_init:function(){this._WS._init(this.cardId)},_initScript:function(){var e=0,n=2,i=5e3,u=a+"/lib/",o=this,r=function(){e++,e==n&&o._init()};!t.jQuery||t.jQuery&&t.jQuery().jquery.substring(0,3)<1.9?(n++,d.loadScript(u+"jquery-2.1.3.min.js",function(){s=jQuery.noConflict(!0),r()})):s=t.jQuery,d.loadScript(u+"sockjs-1.0.0.min.js",r),d.loadScript(u+"stomp.min.js",r),setTimeout(function(){e!=n&&console.error("js\u6587\u4ef6\u52a0\u8f7d\u8d85\u65f6")},i)},addActions:function(t){var e=!1;return"object"==typeof t&&this._WS&&(e=this._WS.addActions(t)),e}},t.GHSMLib=new c}(window,document);